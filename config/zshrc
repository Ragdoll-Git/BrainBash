# Enable Powerlevel10k instant prompt. Should stay close to the top of ~/.zshrc.
# Initialization code that may require console input (password prompts, [y/n]
# confirmations, etc.) must go above this block; everything else may go below.
if [[ -r "${XDG_CACHE_HOME:-$HOME/.cache}/p10k-instant-prompt-${(%):-%n}.zsh" ]]; then
  source "${XDG_CACHE_HOME:-$HOME/.cache}/p10k-instant-prompt-${(%):-%n}.zsh"
fi

# ==========================================
# CONFIGURACION BASICA ZSH
# ==========================================

# Path to your oh-my-zsh installation.
export ZSH="$HOME/.oh-my-zsh"

# Theme: Starship (Si esta instalado), sino robbyrussell
if command -v starship >/dev/null; then
    ZSH_THEME="" # Desactivamos theme de OMZ para dejar a Starship
else
    ZSH_THEME="robbyrussell"
fi

# Plugins
plugins=(git python pip sudo zoxide fzf)

source $ZSH/oh-my-zsh.sh

# ==========================================
# HERRAMIENTAS MODERNAS (Si existen)
# ==========================================

# 1. Starship (Prompt)
if command -v starship >/dev/null; then
    eval "$(starship init zsh)"
fi

# 2. Zoxide (Autojump)
if command -v zoxide >/dev/null; then
    eval "$(zoxide init zsh)"
    alias cd="z"
fi

# 3. FZF (Buscador)
# Debian stable often has old fzf versions that don't support --zsh.
# The 'fzf' plugin in OMZ (enabled above) handles this sufficiently for now.
# if command -v fzf >/dev/null; then
#     source <(fzf --zsh)
# fi

# 4. Eza (ls replacement)
if command -v eza >/dev/null; then
    alias ls="eza --icons"
    alias ll="eza -lh --icons"
    alias la="eza -lah --icons"
    alias tree="eza --tree --icons"
fi

# 5. Bat (cat replacement)
# Debian instala como batcat, otros como bat. Unificamos.
if command -v batcat >/dev/null; then
    alias cat="batcat"
elif command -v bat >/dev/null; then
    alias cat="bat"
fi

# 6. The Fuck (Corrector)
if command -v thefuck >/dev/null; then
    eval $(thefuck --alias)
fi

# 7. Tldr (Manuales)
if command -v tldr >/dev/null; then
    alias help="tldr"
fi

# ==========================================
# ALIAS DE IA (Gemini & Ollama)
# ==========================================

# --- OLLAMA CHECKER ---
# Helper para iniciar Ollama si no esta corriendo
check_ollama() {
    # 1. Check rapido de proceso
    if pgrep -x "ollama" >/dev/null; then
        return 0
    fi
    
    # 2. Check de puerto (por si corre con otro nombre o en contenedor)
    if command -v curl >/dev/null; then
        if curl -s localhost:11434 >/dev/null; then
            return 0
        fi
    fi

    echo "⏳ Iniciando servidor Ollama..."
    ollama serve >/dev/null 2>&1 &
    
    # Esperar un poco a que arranque
    for i in {1..5}; do
        sleep 1
        if pgrep -x "ollama" >/dev/null; then
            return 0
        fi
    done
    
    echo "❌ No se pudo iniciar Ollama."
    return 1
}

# 1. GEMINI (Nube)
# (El script setup.py crea el alias 'gemini' apuntando al venv)
# Solo necesitamos asegurarnos que ~/.local/bin este en PATH
export PATH="$HOME/.local/bin:$PATH"
alias gemini:="gemini"

# 2. MODELOS LOCALES (Ollama)
# Estos alias llaman a los scripts wrapper creados por el instalador

# Qwen (Coding/Ligero)
if [ -f "$HOME/.local/bin/qwen" ]; then
    alias qwen:='check_ollama && "$HOME/.local/bin/qwen"'
fi

# Gemma (Balanceado)
if [ -f "$HOME/.local/bin/gemma" ]; then
    alias gemma:='check_ollama && "$HOME/.local/bin/gemma"'
fi

# Phi (Razonamiento)
if [ -f "$HOME/.local/bin/phi" ]; then
    alias phi:='check_ollama && "$HOME/.local/bin/phi"'
fi

# Acceso directo al manager de modelos
alias models="ollama list"

# ==========================================
# MISC
# ==========================================

# Cargar secretos (API Key) si existen
# Intentar cargar desde HOME real primero, por si sudo confunde el ~
if [ -f "/home/$USER/.brainbash_secrets" ]; then
    source "/home/$USER/.brainbash_secrets"
elif [ -f "$HOME/.brainbash_secrets" ]; then
    source "$HOME/.brainbash_secrets"
fi

# Fix locale
export LANG=en_US.UTF-8
